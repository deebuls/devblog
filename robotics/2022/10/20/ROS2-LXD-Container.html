<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Running ros2 humble in ubuntu lxd container</h1><p class="page-description">Running ros2 humble in ubuntu lxd container</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-10-20T00:00:00-05:00" itemprop="datePublished">
        Oct 20, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/devblog/categories/#robotics">robotics</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#ros2-in-lxd-container">ROS2 in Lxd container</a>
<ul>
<li class="toc-entry toc-h2"><a href="#lxd-start-easy-steps">LXD start easy steps</a></li>
<li class="toc-entry toc-h2"><a href="#lxd-and-ros2-installation">LXD and ROS2 installation</a></li>
<li class="toc-entry toc-h2"><a href="#comman-commands-to-get-started-with-lxc-development">Comman Commands to get started with lxc development</a></li>
<li class="toc-entry toc-h2"><a href="#appendix">Appendix</a></li>
<li class="toc-entry toc-h2"><a href="#additional-noetic-in-lxc">Additional: Noetic in LXC</a></li>
</ul>
</li>
</ul><h1 id="ros2-in-lxd-container">
<a class="anchor" href="#ros2-in-lxd-container" aria-hidden="true"><span class="octicon octicon-link"></span></a>ROS2 in Lxd container</h1>

<p>Its always dificult to get the appropriate ubuntu version for a running a particular software. For example, currently I have ubuntu 20.04 and I want to test a software in ros2 humble. Humble requires ubuntu version 22.04.
I wanted to try if we can use lxd containers for running the appropriate ubuntu version and installing ros in those.</p>

<h2 id="lxd-start-easy-steps">
<a class="anchor" href="#lxd-start-easy-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>LXD start easy steps</h2>

<ol>
  <li>Install lxd in your ubuntu (Using snap)</li>
  <li>Use Lxc to  make sure its  without sudo</li>
  <li>For using gui inside the container we need to attach profiles to the container.</li>
  <li>Create a profile using the following command
    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ lxc profile create x11
Profile x11 created
</code></pre></div>    </div>
  </li>
  <li>Edit the profile with the following command
    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ lxc profile edit x11
</code></pre></div>    </div>
  </li>
  <li>Copy paste below in the editor below</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">config</span><span class="pi">:</span>
  <span class="s">environment.DISPLAY</span><span class="pi">:</span> <span class="s">:0</span>
  <span class="s">environment.PULSE_SERVER</span><span class="pi">:</span> <span class="s">unix:/home/ubuntu/pulse-native</span>
  <span class="s">nvidia.driver.capabilities</span><span class="pi">:</span> <span class="s">all</span>
  <span class="s">nvidia.runtime</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="s">user.user-data</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">#cloud-config</span>
    <span class="s">runcmd:</span>
      <span class="s">- 'sed -i "s/; enable-shm = yes/enable-shm = no/g" /etc/pulse/client.conf'</span>
    <span class="s">packages:</span>
      <span class="s">- x11-apps</span>
      <span class="s">- mesa-utils</span>
      <span class="s">- pulseaudio</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">GUI LXD profile</span>
<span class="na">devices</span><span class="pi">:</span>
  <span class="na">PASocket1</span><span class="pi">:</span>
    <span class="na">bind</span><span class="pi">:</span> <span class="s">container</span>
    <span class="na">connect</span><span class="pi">:</span> <span class="s">unix:/run/user/1000/pulse/native</span>
    <span class="na">listen</span><span class="pi">:</span> <span class="s">unix:/home/ubuntu/pulse-native</span>
    <span class="s">security.gid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="s">security.uid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="na">uid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="na">gid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0777"</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">proxy</span>
  <span class="na">X0</span><span class="pi">:</span>
    <span class="na">bind</span><span class="pi">:</span> <span class="s">container</span>
    <span class="na">connect</span><span class="pi">:</span> <span class="s">unix:@/tmp/.X11-unix/X1</span>
    <span class="na">listen</span><span class="pi">:</span> <span class="s">unix:@/tmp/.X11-unix/X0</span>
    <span class="s">security.gid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="s">security.uid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">proxy</span>
  <span class="na">mygpu</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">gpu</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">x11</span>
<span class="na">used_by</span><span class="pi">:</span> <span class="pi">[]</span>
</code></pre></div></div>

<ol>
  <li>In the above file check the line <code class="highlighter-rouge">connect: unix:@/tmp/.X11-unix/X1</code> This depends on how your local machine DISPLAY is set. If your local machine DISPLAY is at X1 replace there with X0.</li>
  <li>To check your local machine display<code class="highlighter-rouge">echo $DISPLAY</code>.</li>
  <li>Now lets create a container with the profile
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>lxc launch ubuntu:22.04 <span class="nt">--profile</span> default <span class="nt">--profile</span> x11 mycontainer
</code></pre></div>    </div>
  </li>
  <li>To get a shell in the container, run the following.
    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ lxc exec mycontainer -- sudo --user ubuntu --login
mycontainer $ sudo apt install xclock 
mycontainer $ export DISPLAY=:0  #Add this in bashrc
mycontainer $ xclock
</code></pre></div>    </div>
  </li>
  <li>The above command will open the xclock in GUI . If the GUI doesnt come then check your local DISPLAY and the DISPLAY inside the container.</li>
  <li>Complete blog with explanation on the process is provided by (Simos)[https://blog.simos.info/running-x11-software-in-lxd-containers/]</li>
</ol>

<h2 id="lxd-and-ros2-installation">
<a class="anchor" href="#lxd-and-ros2-installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>LXD and ROS2 installation</h2>
<ol>
  <li>Started with <a href="https://canonical.com/blog/install-ros-2-humble-in-ubuntu-20-04-or-18-04-using-lxd-containers">blog by ubuntu</a>
</li>
  <li>It gets you through the installation .
    <ul>
      <li>I created a ubuntu 22.04 container and installed ros2 inside it .</li>
      <li>I create a user called ubuntu</li>
      <li>for ros installation I followed ros2 documentation</li>
    </ul>
  </li>
  <li>For using ros started ros2 tutorials</li>
  <li>First problem gui not working
    <ul>
      <li>Blog by <a href="https://nickdgreg.github.io/software/2020/08/06/running-ros-in-lxd/">Nick D Greg</a> introduced the topic of using profiles</li>
      <li>Following the blog I created a lxc profile named gui</li>
      <li>The blog assumes you start from begining but since we already had the container running we used the below command</li>
      <li>
        <blockquote>
          <p>lxc profile assign ros-humble default,gui</p>
        </blockquote>
      </li>
      <li>inside the container ‘export DISPLAY=:0’ in the bash (also added in bashrc)</li>
      <li>now gui is running</li>
      <li><code class="highlighter-rouge">$&gt; ros2 run turtlesim turtlesim_node</code></li>
    </ul>
  </li>
</ol>

<h2 id="comman-commands-to-get-started-with-lxc-development">
<a class="anchor" href="#comman-commands-to-get-started-with-lxc-development" aria-hidden="true"><span class="octicon octicon-link"></span></a>Comman Commands to get started with lxc development</h2>

<ol>
  <li>Boot your local ubuntu and first you want to check the active containers the command is <code class="highlighter-rouge">lxc list</code>
    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$&gt; lxc list
+------------+---------+----------------------+-----------------------------------------------+-----------+-----------+
|    NAME    |  STATE  |         IPV4         |                     IPV6                      |   TYPE    | SNAPSHOTS |
+------------+---------+----------------------+-----------------------------------------------+-----------+-----------+
| ros-humble | RUNNING | 10.171.226.72 (eth0) | fd42:13f7:78ed:7795:216:3eff:fe9c:bde9 (eth0) | CONTAINER | 0         |
+------------+---------+----------------------+-----------------------------------------------+-----------+-----------+
</code></pre></div>    </div>
  </li>
  <li>Getting bash access
    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ lxc exec ros-humble -- su --login ubuntu
ubuntu@ubuntu-container:~$ 
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="appendix">
<a class="anchor" href="#appendix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendix</h2>
<p>History of comands used insde the container, after logging</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2  apt-cache policy | grep universe
3  sudo apt install software-properties-common
4  sudo add-apt-repository universe
5  sudo apt update &amp;&amp; sudo apt install curl gnupg lsb-release
6  sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
7  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(source /etc/os-release &amp;&amp; echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list &gt; /dev/null
8  sudo apt update &amp;&amp; sudo apt install -y   build-essential   cmake   git   python3-colcon-common-extensions   python3-flake8   python3-flake8-blind-except   python3-flake8-builtins   python3-flake8-class-newline   python3-flake8-comprehensions   python3-flake8-deprecated   python3-flake8-docstrings   python3-flake8-import-order   python3-flake8-quotes   python3-pip   python3-pytest   python3-pytest-cov   python3-pytest-repeat   python3-pytest-rerunfailures   python3-rosdep   python3-setuptools   python3-vcstool   wget
9  sudo apt update
10  sudo apt install ros-humble-desktop
</code></pre></div></div>

<h2 id="additional-noetic-in-lxc">
<a class="anchor" href="#additional-noetic-in-lxc" aria-hidden="true"><span class="octicon octicon-link"></span></a>Additional: Noetic in LXC</h2>
<ol>
  <li>Steps in the host computer to dowload ubuntu 20  and login to the virtual machine</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ lxc launch images:ubuntu/20.04 noetic
Creating noetic
Starting noetic  
$ lxc list
+------------+---------+----------------------+----------------------------------------------+-----------+-----------+
|    NAME    |  STATE  |         IPV4         |                     IPV6                     |   TYPE    | SNAPSHOTS |
+------------+---------+----------------------+----------------------------------------------+-----------+-----------+
| noetic     | RUNNING | 10.171.226.67 (eth0) | fd42:13f7:78ed:7795:216:3eff:fe25:30f (eth0) | CONTAINER | 0         |
+------------+---------+----------------------+----------------------------------------------+-----------+-----------+
$ lxc exec noetic -- su --login ubuntu
To run a command as administrator (user "root"), use "sudo &lt;command&gt;".
See "man sudo_root" for details.

ubuntu@noetic:~$ 

</code></pre></div></div>

<ol>
  <li>For the GUI you have to stop and attach profile read above about creating a profile names x11
    <div class="highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>ubuntu@noetic:~$  exit
$ lxc stop noetic
$ lxc profile assign noetic default,x11 #or whatever name is given to profile. Check above on how to create profile
$ lxc start noetic
ubuntu@noetic:~$ sudo apt install x11-apps
ubuntu@noetic:~$ xclock #should display the clock if not then check the DISPLAY value in both host and container
</code></pre></div>    </div>
  </li>
  <li>Steps in the the container for installing ros and graphics
```bash
// Follow the ros noetic page 
// Additional before adding keys install gpg</li>
</ol>

<p>sudo apt install gpg</p>

<p>```</p>

<p>You have a working ubuntu noetic container with ros noetic.</p>

  </div><a class="u-url" href="/devblog/robotics/2022/10/20/ROS2-LXD-Container.html" hidden></a>
</article>